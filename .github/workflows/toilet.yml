name: Enable RDP with Pinggy

on:
  workflow_dispatch:

jobs:
  enable-rdp:
    runs-on: windows-latest
    steps:
      - name: üîë Enable Terminal Services (RDP)
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

      - name: üîê Set password for runneradmin
        run: |
          net user runneradmin "P@ssw0rd!"
          
      - name: üöÄ Start Pinggy SSH in Background with Log Capture
        shell: powershell
        run: |
          Write-Host "Starting Pinggy in background..."
          $log = "pinggy.log"
          $psi = New-Object System.Diagnostics.ProcessStartInfo
          $psi.FileName = "ssh"
          $psi.Arguments = "-p 443 -R0:localhost:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 t5w9T4lcjRY+tcp@free.pinggy.io"
          $psi.RedirectStandardOutput = $true
          $psi.RedirectStandardError = $true
          $psi.UseShellExecute = $false
          $psi.CreateNoWindow = $true

          $process = New-Object System.Diagnostics.Process
          $process.StartInfo = $psi
          $null = $process.Start()

          Start-Sleep -Seconds 10

          $stdout = $process.StandardOutput.ReadToEnd()
          $stderr = $process.StandardError.ReadToEnd()
          $output = "$stdout`n$stderr"
          $output | Out-File $log

          if ($output -match "https:\/\/[^\s]+\.pinggy\.io") {
              Write-Host "Link found: $($matches[0])"
          } else {
              Write-Host "Pinggy link not found."
              Write-Host "Full output for debugging:"
              Write-Host $output
          }
      - name: ‚úÖ Done
        run: echo skibidi
