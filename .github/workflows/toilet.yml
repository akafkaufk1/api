name: Enable RDP with Pinggy

on:
  workflow_dispatch:

jobs:
  enable-rdp:
    runs-on: windows-latest
    steps:
      - name: üîë Enable Terminal Services (RDP)
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

      - name: üîê Set password for runneradmin
        run: |
          net user runneradmin "P@ssw0rd!"
          
      - name: üì• Start Pinggy Tunnel in Background
        shell: powershell
        run: |
          Write-Host "Starting Pinggy SSH tunnel..."
          Start-Process -FilePath "ssh" `
            -ArgumentList "-p 443 -R0:localhost:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 t5w9T4lcjRY+tcp@free.pinggy.io" `
            -RedirectStandardOutput "pinggy.log" `
            -RedirectStandardError "pinggy.log" `
            -NoNewWindow

      - name: üïµÔ∏è Wait and Parse Link
        shell: cmd
        run: |
          timeout /t 10 >nul
          echo üîç Reading pinggy.log...
          if exist pinggy.log (
            for /f "tokens=*" %%i in (pinggy.log) do (
              echo %%i | findstr "https://*.pinggy.io" >nul
              if not errorlevel 1 (
                echo ‚úÖ Link found: %%i
              )
            )
          ) else (
            echo ‚ùå pinggy.log not found.
          )

      - name: ‚úÖ Done
        run: echo skibidi
