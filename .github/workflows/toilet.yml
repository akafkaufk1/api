name: Enable RDP with Pinggy

on:
  workflow_dispatch:

jobs:
  enable-rdp:
    runs-on: windows-latest
    steps:
      - name: ðŸ”‘ Enable Terminal Services (RDP)
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

      - name: ðŸ” Set password for runneradmin
        run: |
          net user runneradmin "P@ssw0rd!"
          
      - name: âš™ï¸ Start Pinggy SSH in Background
        run: |
          echo ðŸ”„ Starting Pinggy in background...
          start /b cmd /c "ssh -p 443 -R0:localhost:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 t5w9T4lcjRY+tcp@free.pinggy.io > pinggy.log 2>&1"
          timeout /t 10 >nul
          echo ðŸ” Parsing pinggy.log...
          for /f "tokens=*" %%i in (pinggy.log) do (
            echo %%i | findstr "https://*.pinggy.io" >nul
            if not errorlevel 1 (
              echo âœ… Link found: %%i
            )
          )
        shell: cmd

      - name: âœ… Done
        run: echo skibidi
