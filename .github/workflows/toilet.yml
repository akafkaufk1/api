name: Enable RDP with Pinggy

on:
  workflow_dispatch:

jobs:
  enable-rdp:
    runs-on: windows-latest
    steps:
      - name: üîë Enable Terminal Services (RDP)
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

      - name: üîê Set password for runneradmin
        run: |
          net user runneradmin "P@ssw0rd!"
          
      - name: üöÄ Run SSH Tunnel with Pinggy
        run: |
          $logPath = "$env:TEMP\pinggy_output.txt"
          Start-Process -NoNewWindow -FilePath "cmd.exe" -ArgumentList "/c ssh -p 443 -R0:localhost:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 t5w9T4lcjRY+tcp@free.pinggy.io > `"$logPath`"" 
          Start-Sleep -Seconds 5
          $content = Get-Content $logPath | Select-String -Pattern "https://.*\.pinggy\.io"
          if ($content) {
            Write-Host "üåê Pinggy link: $($content.Matches.Value)"
          } else {
            Write-Host "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y link trong log."
          }
      - name: ‚úÖ Done
        run: echo skibidi
